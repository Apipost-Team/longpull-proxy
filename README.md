# longpull-proxy
一个将普遍http请求转换为long pull请求的代理。用于微信扫描登陆等场景。  
HTTP 长轮询(Long Polling) 是一种实现服务器推送的技术。能减少资源消耗，更好的实时性和用户体验。  
本代理能把普通HTTP轮询请求自动转换为HTTP长轮询。  

# 原理
这是一个透明代理。当后端返回Header中带有X-Block:10s 时，代理主动阻塞请求10s。
后端需要返回及时返回数据时候，调用代理/cancel 方法主动取消阻塞。  
可选支持redis Subscribe 一个channel  
头部增加x-backend 支持重新指定后端  

# 最佳实践
使用 HTTP 长轮询技术实现微信扫码登录可以提供实时的登录状态更新。
## 前端
 - 在前端页面中，创建一个长轮询的 AJAX 请求，用于获取登录状态
 - 当用户扫描二维码并授权后，前端发送长轮询请求给后端，等待后端的响应。
 - 如果后端返回登录成功的响应，前端可以执行登录成功后的操作，如跳转到用户首页。

## 后端
 - 后端接收到长轮询请求后，检查用户的登录状态。
 - 如果用户已成功登录，后端立即返回登录成功的响应给前端。
 - 如果用户还未完成登录，后端将请求头部增加X-Block:30s，代理会将用户请求挂起30s 等待登录状态更新。 
 - 当用户完成登录后，后端主动取消代理挂起，代理立即将最新登录成功的响应给前端。

# 启动方式
go run proxy.go -port 8080 -backend http://127.0.0.1:9999 -debug=1
go run proxy.go -port 8080 -backend http://127.0.0.1:9999 -debug=1 -redis "redis://172.17.101.191:6378?db=1&password=apipost&channel=weixin"

# 内置方法
## 主动取消阻塞 /cancel
方法: GET OR POST  
参数: etag (取消阻塞的etag)
返回 HTTP CODE： --
 - 200 取消成功
 - 500 参数错误
 - 404 取消目标不存在

## 查看状态 /status
方法: GET  
用于查看服务器状态
